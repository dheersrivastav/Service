<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="pcrepair.css">
    <title>Service Form</title>
    <link rel="stylesheet" href="form.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="menu">
        <div class="upheader">
            <h1 id="service-header" class="BodhGayabanner">Order Summary</h1>
        </div>
    </div>

    <div class="banner2">
        <div id="order-summary"></div>
    </div>

    <div class="form-container">
        <h1>Service Details</h1>
        <form id="service-form" name="google-sheet">
            <label for="name">Name:</label>
            <input type="text" id="name" name="name" required><br>
            <label for="email">Email:</label>
            <input type="email" id="email" name="email" required><br>
            <label for="phone">Phone:</label>
            <input type="tel" id="phone" name="phone" required><br>
            <label for="address">Address:</label>
            <input type="text" id="address" name="address" required><br>
            <label for="pincode">Pin Code:</label>
            <input type="text" id="pincode" name="pincode" required><br>
            <input type="submit" value="Place Order">
        </form>
    </div>

    <div id="popup-message" style="display:none;">
        <h2>Order Placed Successfully!</h2>
        <button onclick="closePopup()">Close</button>
        <button id="download-invoice">Download Invoice</button>
    </div>

    <script>
        function getQueryParams() {
            const params = {};
            const queryString = window.location.search.substring(1);
            const regex = /([^&=]+)=([^&]*)/g;
            let m;
            while (m = regex.exec(queryString)) {
                params[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
            }
            return params;
        }

        function showPopup() {
            document.getElementById('popup-message').style.display = 'block';
        }

        function closePopup() {
            document.getElementById('popup-message').style.display = 'none';
        }

        function loadOrderSummary() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const orderSummary = document.getElementById('order-summary');

            if (cart.length === 0) {
                orderSummary.innerHTML = '<p>No services selected.</p>';
                return;
            }

            cart.forEach(service => {
                const serviceDiv = document.createElement('div');
                serviceDiv.classList.add('order-item');
                serviceDiv.innerHTML = `
                    <img src="${service.img}" class="order-img" alt="${service.text}">
                    <h2>${service.text}</h2>
                `;
                orderSummary.appendChild(serviceDiv);
            });
        }

        function generateInvoice(formData, cart) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.text("Invoice", 20, 20);
            doc.text(`Name: ${formData.get('name')}`, 20, 30);
            doc.text(`Email: ${formData.get('email')}`, 20, 40);
            doc.text(`Phone: ${formData.get('phone')}`, 20, 50);
            doc.text(`Address: ${formData.get('address')}`, 20, 60);
            doc.text(`Pin Code: ${formData.get('pincode')}`, 20, 70);

            let yOffset = 80;
            cart.forEach((service, index) => {
                doc.text(`Service ${index + 1}: ${service.text}`, 20, yOffset);
                yOffset += 10;
            });

            doc.save('invoice.pdf');
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadOrderSummary();

            document.getElementById('service-form').addEventListener('submit', function(event) {
                event.preventDefault();

                const form = document.getElementById('service-form');
                const scriptURL = 'https://script.google.com/macros/s/AKfycbwy8xaZDciZIBhFF33Y-YiwhxWloH5t_tFuxrei1SlaJqCJt0EedVlHYSKqvc0hslq-/exec';
                const formData = new FormData(form);
                const cart = JSON.parse(localStorage.getItem('cart')) || [];

                fetch(scriptURL, { method: 'POST', body: formData })
                    .then(response => {
                        console.log('Success!', response);
                        localStorage.removeItem('cart');
                        showPopup();
                    })
                    .catch(error => console.error('Error!', error.message));

                document.getElementById('download-invoice').addEventListener('click', () => {
                    generateInvoice(formData, cart);
                });
            });
        });
    </script>
</body>
</html>
